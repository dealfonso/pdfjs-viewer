/* Copyright 2021 Carlos A. (https://github.com/dealfonso); License: http://www.apache.org/licenses/LICENSE-2.0 */
(function(exports,$){"use strict";let defaults={visibleThreshold:.5,extraPagesToLoad:3,pageClass:"pdfpage",contentClass:"content-wrapper",onDocumentReady:()=>{},onNewPage:(t,e)=>{},onPageRender:(t,e)=>{},errorPage:()=>{$(`<div class="placeholder"></div>`).addClass(this.settings.pageClass).append($(`<p class="m-auto"></p>`).text("could not load document"))},zoomValues:[.25,.5,.75,1,1.25,1.5,2,4,8],onZoomChange:t=>{},onActivePageChanged:(t,e)=>{},zoomFillArea:.95,emptyContent:()=>$('<div class="loader"></div>')};class Zoomer{constructor(t,e={}){let i={zoomValues:[.25,.5,.75,1,1.25,1.5,2,4,8],fillArea:.9};this.current=1;this.viewer=t;this.settings=$.extend(i,e);this.settings.zoomValues=this.settings.zoomValues.sort()}get(e=null){if(e===null){return this.current}if(parseFloat(e)==e){return e}let t=this.viewer.getActivePage();let i=[];switch(e){case"in":e=this.current;i=this.settings.zoomValues.filter(t=>t>e);if(i.length>0){e=Math.min(...i)}break;case"out":e=this.current;i=this.settings.zoomValues.filter(t=>t<e);if(i.length>0){e=Math.max(...i)}break;case"fit":e=Math.min(this.get("width"),this.get("height"));break;case"width":e=this.settings.fillArea*this.viewer.$container.width()/t.data("width");break;case"height":e=this.settings.fillArea*this.viewer.$container.height()/t.data("height");break;default:e=this.current;break}return e}zoomPages(a){a=this.get(a);this.viewer.getPages().forEach(function(t){let e=t.$div;let i=e.data("width");let s=e.data("height");e.width(i*a).height(s*a);e.data("zoom",a);e.find(`.${this.viewer.settings.contentClass}`).width(i*a).height(s*a)}.bind(this));this.current=a}}class PDFjsViewer{constructor(t,e={}){this.settings=$.extend(Object.assign({},defaults),e);this._zoom=new Zoomer(this,{zoomValues:this.settings.zoomValues,fillArea:this.settings.zoomFillArea});this.$container=t;t.get(0)._pdfjsViewer=this;this._setScrollListener();this.pages=[];this.pdf=null;this._documentReady=false}setZoom(t){let e=this.$container.get(0);let i=this._zoom.current;let s={top:e.scrollTop,left:e.scrollLeft};this._zoom.zoomPages(t);e.scrollLeft=s.left*this._zoom.current/i;e.scrollTop=s.top*this._zoom.current/i;this._visiblePages(true);if(this._documentReady){if(typeof this.settings.onZoomChange==="function")this.settings.onZoomChange.call(this,this._zoom.current);this.$container.get(0).dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:this._zoom.current}}))}return this._zoom.current}getZoom(){return this._zoom.current}_cleanPage(t){let e=this.settings.emptyContent();t.find(`.${this.settings.contentClass}`).empty().append(e)}_setPageContent(t,e){t.find(`.${this.settings.contentClass}`).empty().append(e)}refreshAll(){this._visiblePages(true)}_setScrollListener(){let i=false;let s={top:0,left:0};this.__scrollHandler=function(t){if(i===true){return}i=true;let e=this.$container.get(0);if(Math.abs(e.scrollTop-s.top)>e.clientHeight*.2*this._zoom.current||Math.abs(e.scrollLeft-s.left)>e.clientWidth*.2*this._zoom.current){s={top:e.scrollTop,left:e.scrollLeft};this._visiblePages()}i=false}.bind(this);this.$container.off("scroll");this.$container.on("scroll",this.__scrollHandler)}_createSkeleton(e,t){let i={$div:null,width:0,height:0,loaded:false};if(e.getViewport!==undefined){let t=e.getViewport({rotation:this._rotation,scale:1});i.width=t.width;i.height=t.height;i.loaded=true}else{i.width=e.width;i.height=e.height}console.assert(i.width>0&&i.height>0,"Page width and height must be greater than 0");i.$div=$(`<div id="page-${t}">`).attr("data-page",t).data("width",i.width).data("height",i.height).data("zoom",this._zoom.current).addClass(this.settings.pageClass).width(i.width*this._zoom.current).height(i.height*this._zoom.current);let s=$(`<div class="${this.settings.contentClass}">`).width(i.width).height(i.height);i.$div.append(s);this._cleanPage(i.$div);return i}_placeSkeleton(t,e){let i=e-1;let s=null;while(i>0&&(s=this.$container.find(`.${this.settings.pageClass}[data-page="${i}"]`)).length===0){i--}if(i===0){this.$container.append(t.$div)}else{s.after(t.$div)}}_createSkeletons(e){for(let t=1;t<=this.pageCount;t++){if(this.pages[t]===undefined){e=this._createSkeleton(e,t);this.pages[t]=e;this._placeSkeleton(e,t);if(this._documentReady){if(typeof this.settings.onNewPage==="function"){this.settings.onNewPage.call(this,e.$div,t)}this.$container.get(0).dispatchEvent(new CustomEvent("newpage",{detail:{pageNumber:t,page:e.$div.get(0)}}))}}}}_setActivePage(e){if(this._activePage!==e){this._activePage=e;let t=this.getActivePage();if(this._documentReady){if(typeof this.settings.onActivePageChanged==="function")this.settings.onActivePageChanged.call(this,t,e);this.$container.get(0).dispatchEvent(new CustomEvent("activepagechanged",{detail:{activePageNumber:e,activePage:t==null?null:t.get(0)}}))}}}_areaOfPageVisible(t){if(t===undefined){return 0}let e=this.$container.offset();let i=this.$container.width();let s=this.$container.height();let a=t.offset();a.top-=e.top;a.left-=e.left;a.bottom=a.top+t.outerHeight();a.right=a.left+t.outerWidth();let n=Math.min(Math.max(a.top,0),s);let h=Math.min(Math.max(t.outerHeight()+a.top,0),s);let o=Math.min(Math.max(a.left,0),i);let l=Math.min(Math.max(t.outerWidth()+a.left,0),i);let r=l-o;let g=h-n;return r*g}isPageVisible(t){if(this.pdf===null||t===undefined||t===null||t<1||t>this.pdf.numPages){return false}let e=t;if(typeof t==="number"){if(this.pages[t]===undefined)return false;e=this.pages[t].$div}return this._areaOfPageVisible(e)>e.outerWidth()*e.outerHeight()*this.settings.visibleThreshold}_visiblePages(t=false){let i=0;let s=null;if(this.pages.length===0){this._visibles=[];this._setActivePage(0);return}let e=this.pages.filter(function(t){let e=this._areaOfPageVisible(t.$div);if(e>i){i=e;s=t.$div.data("page")}return e>0}.bind(this)).map(t=>t.$div);this._setActivePage(s);let a=e.map(t=>$(t).data("page"));if(a.length>0){let e=Math.min(...a);let i=Math.max(...a);for(let t=Math.max(1,e-this.settings.extraPagesToLoad);t<e;t++){if(!a.includes(t))a.push(t)}for(let t=i+1;t<=Math.min(i+this.settings.extraPagesToLoad,this.pdf.numPages);t++){if(!a.includes(t))a.push(t)}}let n=a;if(!t){n=a.filter(function(t){return!this._visibles.includes(t)}.bind(this))}this._visibles.filter(function(t){return!a.includes(t)}).forEach(function(t){this._cleanPage(this.pages[t].$div)}.bind(this));this._visibles=a;this.loadPages(...n)}loadPages(...t){this._pagesLoading.push(...t);if(this._loading){return}this._loadingTask()}_loadingTask(){this._loading=true;if(this._pagesLoading.length>0){let e=this._pagesLoading.shift();this.pdf.getPage(e).then(function(t){this._renderPage(t,e)}.bind(this)).then(function(t){if(this._pagesLoading.length>0){this._loadingTask()}}.bind(this))}this._loading=false}scrollToPage(t){if(this.pages.length===0||this.pages[t]===undefined){return}let e=this.pages[t].$div;if(e.length===0){console.warn(`Page ${t} not found`);return}let i=e.position();let s=this.$container.position();if(i!==undefined){this.$container.get(0).scrollTop=this.$container.get(0).scrollTop+i.top-s.top;this.$container.get(0).scrollLeft=this.$container.get(0).scrollLeft+i.left-s.left}this._setActivePage(t)}_renderPage(t,e){let i=this.pages[e];let s=Math.max(window.devicePixelRatio||1,1);let a=t.getViewport({rotation:this._rotation,scale:this._zoom.current*s});i.width=a.width/this._zoom.current/s;i.height=a.height/this._zoom.current/s;i.$div.data("width",i.width);i.$div.data("height",i.height);i.$div.width(i.width*this._zoom.current);i.$div.height(i.height*this._zoom.current);i.loaded=true;let n=$("<canvas></canvas>");let h=n.get(0);let o=h.getContext("2d");h.height=a.height;h.width=a.width;h.getContext("2d");var l={canvasContext:o,viewport:a};return t.render(l).promise.then(function(){this._setPageContent(i.$div,n);if(this._documentReady){if(typeof this.settings.onPageRender==="function"){this.settings.onPageRender.call(this,i.$div,e)}this.$container.get(0).dispatchEvent(new CustomEvent("pagerender",{detail:{pageNumber:e,page:i.$div.get(0)}}))}return i}.bind(this))}getActivePage(){if(this._activePage===null||this.pdf===null){return null}if(this._activePage<1||this._activePage>this.pdf.numPages){return null}return this.pages[this._activePage].$div}getPages(){return this.pages}getPageCount(){if(this.pdf===null){return 0}return this.pdf.numPages}next(){if(this._activePage<this.pdf.numPages){this.scrollToPage(this._activePage+1)}}prev(){if(this._activePage>1){this.scrollToPage(this._activePage-1)}}first(){if(this._activePage!==1){this.scrollToPage(1)}}last(){if(this.pdf===null)return;if(this._activePage!==this.pdf.numPages){this.scrollToPage(this.pdf.numPages)}}rotate(t,e=false){if(e){t=t+this._rotation}this._rotation=t;let i=this.$container.get(0);let s={top:i.scrollTop,left:i.scrollLeft,height:i.scrollHeight,width:i.scrollWidth};return this.forceViewerInitialization().then(function(){let t={top:i.scrollTop,left:i.scrollLeft,height:i.scrollHeight,width:i.scrollWidth};i.scrollTop=s.top*(t.height/s.height);i.scrollLeft=s.left*(t.width/s.width)}.bind(this))}forceViewerInitialization(){this.pages=[];this.$container.find(`.${this.settings.pageClass}`).remove();this._pagesLoading=[];this._loading=false;this._visibles=[];this._activePage=null;return this.pdf.getPage(1).then(function(t){this._createSkeletons(t);this._visiblePages();this._setActivePage(1)}.bind(this))}async loadDocument(t){this._documentReady=false;this.pages=[];this.$container.find(`.${this.settings.pageClass}`).remove();this.pdf=null;let e=pdfjsLib.getDocument(t);return e.promise.then(function(t){this.pdf=t;this.pageCount=t.numPages;this._rotation=0;return this.forceViewerInitialization()}.bind(this)).then(function(){if(typeof this.settings.onDocumentReady==="function"){this.settings.onDocumentReady.call(this)}this.$container.get(0).dispatchEvent(new CustomEvent("documentready",{detail:{document:this.pdf}}));this._setActivePage(0);this._documentReady=true;this._setActivePage(1)}.bind(this))}}function recoverAttributes(target,attributeDefaults){const camelcaseToSnakecase=t=>t.replace(/[A-Z]/g,t=>`-${t.toLowerCase()}`);let $target=$(target);let result={};if($target.length>0){$target=$($target[0]);for(let originalAttributeName in attributeDefaults){let attributeName=camelcaseToSnakecase(originalAttributeName);let attributeValue=$target.attr(attributeName);if(attributeValue!=null){switch(typeof attributeDefaults[originalAttributeName]){case"float":try{attributeValue=parseFloat(attributeValue)}catch(_){}break;case"number":try{attributeValue=parseInt(attributeValue)}catch(_){}break;case"function":let functionString=attributeValue;attributeValue=function(){eval(functionString)}.bind(target[0]);break;default:break}result[originalAttributeName]=attributeValue}}}return result}function init(t){let e=recoverAttributes(t,Object.assign({pdfDocument:"",initialZoom:""},defaults));let i=new PDFjsViewer($(t),e);if(e["pdfDocument"]!=null){i.loadDocument(e["pdfDocument"]).then(function(){if(e["initialZoom"]!=null){i.setZoom(e["initialZoom"])}})}t.get(0).pdfViewer=i}$(function(){$(".pdfjs-viewer").each(function(){let t=$(this);init(t)})});exports.PDFjsViewer=PDFjsViewer})(window,jQuery);
