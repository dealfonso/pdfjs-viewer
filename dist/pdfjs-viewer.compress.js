/* Copyright 2021 Carlos A. (https://github.com/dealfonso); License: http://www.apache.org/licenses/LICENSE-2.0 */
!function(exports,$){if(void 0===$)console.error("jQuery-like library not available");else{let defaults={visibleThreshold:.5,extraPagesToLoad:3,pageClass:"pdfpage",contentClass:"content-wrapper",onDocumentReady:()=>{},onNewPage:(t,e)=>{},onPageRender:(t,e)=>{},zoomValues:[.25,.5,.75,1,1.25,1.5,2,4,8],onZoomChange:t=>{},onActivePageChanged:(t,e)=>{},zoomFillArea:.95,emptyContent:()=>$('<div class="loader"></div>'),renderingScale:1.5};class Zoomer{constructor(t,e={}){this.current=1,this.viewer=t,this.settings=Object.assign({},{zoomValues:[.25,.5,.75,1,1.25,1.5,2,4,8],fillArea:.9},e),this.settings.zoomValues=this.settings.zoomValues.sort()}get(e=null){if(null===e)return this.current;if(parseFloat(e)!=e){var i=this.viewer.getActivePage();let t=[];switch(e){case"in":e=this.current,0<(t=this.settings.zoomValues.filter(t=>e<t)).length&&(e=Math.min(...t));break;case"out":e=this.current,0<(t=this.settings.zoomValues.filter(t=>t<e)).length&&(e=Math.max(...t));break;case"fit":e=Math.min(this.get("width"),this.get("height"));break;case"width":e=this.settings.fillArea*this.viewer.$container.width()/i.data("width");break;case"height":e=this.settings.fillArea*this.viewer.$container.height()/i.data("height");break;default:e=this.current}}return e}zoomPages(s){s=this.get(s),this.viewer.getPages().forEach(function(t){var t=t.$div,e=t.data("width"),i=t.data("height");t.width(e*s).height(i*s),t.data("zoom",s),t.find("."+this.viewer.settings.contentClass).width(e*s).height(i*s)}.bind(this)),this.current=s}}class PDFjsViewer{version="2.0.0";constructor(t,e={}){this.settings=Object.assign({},defaults,e),this._zoom=new Zoomer(this,{zoomValues:this.settings.zoomValues,fillArea:this.settings.zoomFillArea}),t=$(t),((this.$container=t).get(0)._pdfjsViewer=this)._setScrollListener(),this.pages=[],this.pdf=null,this._documentReady=!1}setZoom(t){var e=this.$container.get(0),i=this._zoom.current,s=e.scrollTop,a=e.scrollLeft;return this._zoom.zoomPages(t),e.scrollLeft=a*this._zoom.current/i,e.scrollTop=s*this._zoom.current/i,this._visiblePages(!0),this._documentReady&&("function"==typeof this.settings.onZoomChange&&this.settings.onZoomChange.call(this,this._zoom.current),this.$container.get(0).dispatchEvent(new CustomEvent("zoomchange",{detail:{zoom:this._zoom.current}}))),this._zoom.current}getZoom(){return this._zoom.current}_cleanPage(t){var e=this.settings.emptyContent();t.find("."+this.settings.contentClass).html("").append(e)}_setPageContent(t,e){t.find("."+this.settings.contentClass).html("").append(e)}refreshAll(){this._visiblePages(!0)}_setScrollListener(){let i=!1,s={top:0,left:0};this.__scrollHandler=function(t){var e;!0!==i&&(i=!0,e=this.$container.get(0),(Math.abs(e.scrollTop-s.top)>.2*e.clientHeight*this._zoom.current||Math.abs(e.scrollLeft-s.left)>.2*e.clientWidth*this._zoom.current)&&(s={top:e.scrollTop,left:e.scrollLeft},this._visiblePages()),i=!1)}.bind(this),this.$container.off("scroll"),this.$container.on("scroll",this.__scrollHandler)}_createSkeleton(t,e){var i={$div:null,width:0,height:0,loaded:!1},s=(void 0!==t.getViewport?(s=t.getViewport({rotation:this._rotation,scale:1}),i.width=s.width,i.height=s.height,i.loaded=!0):(i.width=t.width,i.height=t.height),console.assert(0<i.width&&0<i.height,"Page width and height must be greater than 0"),i.$div=$(`<div id="page-${e}">`).attr("data-page",e).data("width",i.width).data("height",i.height).data("zoom",this._zoom.current).addClass(this.settings.pageClass).width(i.width*this._zoom.current).height(i.height*this._zoom.current),$(`<div class="${this.settings.contentClass}">`).width(i.width).height(i.height));return i.$div.append(s),this._cleanPage(i.$div),i}_placeSkeleton(t,e){let i=e-1,s=null;for(;0<i&&0===(s=this.$container.find(`.${this.settings.pageClass}[data-page="${i}"]`)).length;)i--;0===i?this.$container.append(t.$div):s.after(t.$div)}_createSkeletons(e){for(let t=1;t<=this.pageCount;t++)void 0===this.pages[t]&&(e=this._createSkeleton(e,t),this.pages[t]=e,this._placeSkeleton(e,t),"function"==typeof this.settings.onNewPage&&this.settings.onNewPage.call(this,e.$div.get(0),t),this.$container.get(0).dispatchEvent(new CustomEvent("newpage",{detail:{pageNumber:t,page:e.$div.get(0)}})))}_setActivePage(e){if(this._activePage!==e){this._activePage=e;let t=this.getActivePage();this._documentReady&&(t=null==t?null:t.get(0),"function"==typeof this.settings.onActivePageChanged&&this.settings.onActivePageChanged.call(this,t,e),this.$container.get(0).dispatchEvent(new CustomEvent("activepagechanged",{detail:{activePageNumber:e,activePage:t}})))}}_areaOfPageVisible(t){var e,i,s,a,n;return void 0===t?0:(s=this.$container.offset(),e=this.$container.width(),a=this.$container.height(),(i=t.offset()).top-=s.top,i.left-=s.left,i.bottom=i.top+t.outerHeight(),i.right=i.left+t.outerWidth(),s=Math.min(Math.max(i.top,0),a),a=Math.min(Math.max(t.outerHeight()+i.top,0),a),n=Math.min(Math.max(i.left,0),e),(Math.min(Math.max(t.outerWidth()+i.left,0),e)-n)*(a-s))}isPageVisible(t){if(null===this.pdf||null==t||t<1||t>this.pdf.numPages)return!1;let e=t="string"==typeof t?parseInt(t):t;if("number"==typeof t){if(void 0===this.pages[t])return!1;e=this.pages[t].$div}return this._areaOfPageVisible(e)>e.outerWidth()*e.outerHeight()*this.settings.visibleThreshold}_visiblePages(i=!1){let s=0,a=null;if(0===this.pages.length)this._visibles=[],this._setActivePage(0);else{var n=this.pages.filter(function(t){var e=this._areaOfPageVisible(t.$div);return e>s&&(s=e,a=t.$div.data("page")),0<e}.bind(this)).map(t=>t.$div);this._setActivePage(a);let e=n.map(t=>parseInt($(t).data("page")));if(0<e.length){var o=Math.min(...e),h=Math.max(...e);for(let t=Math.max(1,o-this.settings.extraPagesToLoad);t<o;t++)e.includes(t)||e.push(t);for(let t=h+1;t<=Math.min(h+this.settings.extraPagesToLoad,this.pdf.numPages);t++)e.includes(t)||e.push(t)}let t=e;i||(t=e.filter(function(t){return!this._visibles.includes(t)}.bind(this))),this._visibles.filter(function(t){return!e.includes(t)}).forEach(function(t){this._cleanPage(this.pages[t].$div)}.bind(this)),this._visibles=e,this.loadPages(...t)}}loadPages(...t){this._pagesLoading.push(...t),this._loading||this._loadingTask()}_loadingTask(){if(this._loading=!0,0<this._pagesLoading.length){let e=this._pagesLoading.shift();this.pdf.getPage(e).then(function(t){this._renderPage(t,e)}.bind(this)).then(function(t){0<this._pagesLoading.length&&this._loadingTask()}.bind(this))}this._loading=!1}scrollToPage(t){var e,i;0!==this.pages.length&&void 0!==this.pages[t]&&(0===(e=this.pages[t].$div).length?console.warn(`Page ${t} not found`):(e=e.position(),i=this.$container.position(),void 0!==e&&(this.$container.get(0).scrollTop=this.$container.get(0).scrollTop+e.top-i.top,this.$container.get(0).scrollLeft=this.$container.get(0).scrollLeft+e.left-i.left),this._setActivePage(t)))}_renderPage(t,e){let i=this.pages[e];var s=this.settings.renderingScale,a=window.devicePixelRatio||1,n=t.getViewport({rotation:this._rotation,scale:this._zoom.current*s});i.width=n.width/this._zoom.current/s,i.height=n.height/this._zoom.current/s,i.$div.data("width",i.width),i.$div.data("height",i.height),i.$div.width(i.width*this._zoom.current),i.$div.height(i.height*this._zoom.current),i.loaded=!0;let o=$("<canvas></canvas>");var s=o.get(0),h=s.getContext("2d");return s.height=n.height*a,s.width=n.width*a,s.getContext("2d"),t.render({canvasContext:h,viewport:n,transform:1!==a?[a,0,0,a,0,0]:null}).promise.then(function(){return this._setPageContent(i.$div,o),this._documentReady&&("function"==typeof this.settings.onPageRender&&this.settings.onPageRender.call(this,i.$div.get(0),e),this.$container.get(0).dispatchEvent(new CustomEvent("pagerender",{detail:{pageNumber:e,page:i.$div.get(0)}}))),i}.bind(this))}getActivePage(){return null===this._activePage||null===this.pdf||this._activePage<1||this._activePage>this.pdf.numPages?null:this.pages[this._activePage].$div}getPages(){return this.pages}getPageCount(){return null===this.pdf?0:this.pdf.numPages}next(){this._activePage<this.pdf.numPages&&this.scrollToPage(this._activePage+1)}prev(){1<this._activePage&&this.scrollToPage(this._activePage-1)}first(){1!==this._activePage&&this.scrollToPage(1)}last(){null!==this.pdf&&this._activePage!==this.pdf.numPages&&this.scrollToPage(this.pdf.numPages)}rotate(t,e=!1){e&&(t+=this._rotation),this._rotation=t;let i=this.$container.get(0),s={top:i.scrollTop,left:i.scrollLeft,height:i.scrollHeight,width:i.scrollWidth};return this.forceViewerInitialization().then(function(){i.scrollTop,i.scrollLeft;var t=i.scrollHeight,e=i.scrollWidth;i.scrollTop=s.top*(t/s.height),i.scrollLeft=s.left*(e/s.width)}.bind(this))}forceViewerInitialization(){return this.pages=[],this.$container.find("."+this.settings.pageClass).remove(),this._pagesLoading=[],this._loading=!1,this._visibles=[],this._activePage=null,this.pdf.getPage(1).then(function(t){this._createSkeletons(t),this._visiblePages(),this._setActivePage(1)}.bind(this))}async loadDocument(t){return this._documentReady=!1,this.pages=[],this.$container.find("."+this.settings.pageClass).remove(),this.pdf=null,pdfjsLib.getDocument(t).promise.then(function(t){return this.pdf=t,this.pageCount=t.numPages,this._rotation=0,this.forceViewerInitialization()}.bind(this)).then(function(){"function"==typeof this.settings.onDocumentReady&&this.settings.onDocumentReady.call(this),this.$container.get(0).dispatchEvent(new CustomEvent("documentready",{detail:{document:this.pdf}})),this._setActivePage(0),this._documentReady=!0,this._setActivePage(1)}.bind(this))}}function recoverAttributes(target,attributeDefaults){const camelcaseToSnakecase=t=>t.replace(/[A-Z]/g,t=>"-"+t.toLowerCase());let $target=$(target),result={};if(0<$target.length)for(var originalAttributeName in $target=$($target[0]),attributeDefaults){let attributeName=camelcaseToSnakecase(originalAttributeName),attributeValue=$target.attr(attributeName);if(null!=attributeValue){switch(typeof attributeDefaults[originalAttributeName]){case"float":try{attributeValue=parseFloat(attributeValue)}catch(_){}break;case"number":try{attributeValue=parseInt(attributeValue)}catch(_){}break;case"function":let functionString=attributeValue;attributeValue=function(){eval(functionString)}.bind(target[0])}result[originalAttributeName]=attributeValue}}return result}function init(e){let i=recoverAttributes(e,Object.assign({pdfDocument:"",initialZoom:""},defaults));if(null!=i.pdfDocument){let t=new PDFjsViewer($(e),i);t.loadDocument(i.pdfDocument).then(function(){null!=i.initialZoom&&t.setZoom(i.initialZoom)}),e.get(0).pdfViewer=t}}$(function(){$(".pdfjs-viewer").each(function(){init($(this))})}),exports.PDFjsViewer=PDFjsViewer}}(window,window._$??window.jQuery??void 0);